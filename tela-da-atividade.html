<!DOCTYPE html>
<html lang="pt-br">
<head>
    <script src="https://kit.fontawesome.com/fc5a8c4aa2.js" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlfaEduca</title>
    <link rel="stylesheet" href="css/style-tela-da-atividade.css">
</head>
<body>
    <h1 class="titulo">Soma</h1>
    <p class="descricao">Somar números</p>
    <p class="exemplo">10 + 10</p>
    <input type="text" class="resposta" placeholder="Escreva sua resposta aqui">
    <br>
    <button class="btn-enviar" onclick="enviarResposta()">Enviar Resposta</button>
    <p class="tentativas">Tentativas: <span id="tentativas">0</span></p>
    <button class="btn-voltar" onclick="voltar()">Voltar</button>

    <script>
        let tentativas = 0;

        async function criarResposta(token, resposta, atividadeId, usuarioId) {
            try {
                console.log("Iniciando a criação da resposta...");
                console.log("Token:", token);
                console.log("Resposta:", resposta);
                console.log("Atividade ID:", atividadeId);
                console.log("Usuário ID:", usuarioId);

                const response = await fetch(
                    "https://alfa-educa-server.onrender.com/resposta",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                        },
                        body: JSON.stringify({ resposta, atividadeId, usuarioId }),
                    }
                );

                console.log("Resposta do servidor recebida:", response);

                if (!response.ok) {
                    let errorMessage = "Erro ao criar resposta";
                    if (response.status === 400) {
                        const errorResponse = await response.json();
                        errorMessage = `Erro na requisição: ${errorResponse.message}`;
                        console.error("Erro na resposta do servidor:", response.status, response.statusText, errorResponse);
                    } else if (response.status === 401) {
                        errorMessage = "Não autorizado. Verifique suas credenciais.";
                    } else if (response.status === 500) {
                        errorMessage = "Erro no servidor. Tente novamente mais tarde.";
                    } else {
                        console.error("Erro na resposta do servidor:", response.status, response.statusText);
                    }
                    throw new Error(errorMessage);
                }

                const respostaCriada = await response.json();
                console.log("Resposta criada com sucesso:", respostaCriada);
                return respostaCriada;
            } catch (error) {
                console.error("Erro ao criar resposta:", error);
                throw error;
            }
        }

        async function enviarResposta() {
            const resposta = document.querySelector('.resposta').value;
            const token = localStorage.getItem('token');
            const atividadeId = localStorage.getItem('atividadeId');
            const usuarioId = localStorage.getItem('contaId');
            console.log('atividadeId:', atividadeId);
            console.log('usuarioId:', usuarioId); 


            if (resposta == '20') {
                alert('Resposta correta!');
                try {
                    await criarResposta(token, resposta, atividadeId, usuarioId);
                } catch (error) {
                    alert(error.message);
                }
            } else {
                alert('Resposta incorreta. Tente novamente.');
                tentativas++;
                document.getElementById('tentativas').innerText = tentativas;
            }
        }

        function voltar() {
            window.history.back();
        }

        async function fetchAtividade() {
            const atividadeId = localStorage.getItem('atividadeId');
            const token = localStorage.getItem('token');
            console.log('atividadeId:', atividadeId);
            console.log('token:', token);

            if (!atividadeId || !token) {
                console.error('Atividade ID ou token não encontrado no localStorage');
                return;
            }

            try {
                const response = await fetch(`https://alfa-educa-server.onrender.com/atividade/${atividadeId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro na requisição: ' + response.statusText);
                }

                const atividade = await response.json();
                document.querySelector('.titulo').textContent = atividade.titulo;
                document.querySelector('.descricao').textContent = atividade.subtitulo;
                document.querySelector('.exemplo').textContent = atividade.descricao;
            } catch (error) {
                console.error('Erro ao buscar dados da atividade:', error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', fetchAtividade);
    </script>
</body>
</html>